<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Temp Mail</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 900px; margin: 0 auto; }

    header { text-align: center; margin-bottom: 30px; }

    h1 {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle { color: #94a3b8; margin-top: 8px; }

    .warning {
      background: #f59e0b20;
      border: 1px solid #f59e0b;
      color: #fbbf24;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .card {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #334155;
    }

    .email-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .email-input {
      flex: 1;
      min-width: 250px;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 12px;
      padding: 14px 18px;
      color: #f8fafc;
      font-size: 1.1rem;
      font-family: 'SF Mono', monospace;
      outline: none;
    }

    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #334155;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-checking { background: #f59e0b20; color: #fbbf24; }
    .status-connected { background: #10b98120; color: #10b981; }

    .pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .inbox-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .inbox-title { font-size: 1.2rem; font-weight: 600; }

    .badge {
      background: #3b82f6;
      color: white;
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .email-list { max-height: 600px; overflow-y: auto; }

    .email-item {
      padding: 20px 24px;
      border-bottom: 1px solid #334155;
      cursor: pointer;
      transition: background 0.2s;
    }

    .email-item:hover { background: #252f47; }
    .email-item:last-child { border-bottom: none; }
    .email-item.unread { border-left: 3px solid #3b82f6; }

    .email-from { font-weight: 600; color: #f8fafc; word-break: break-all; }
    .email-subject { color: #94a3b8; margin: 8px 0; }
    .email-preview { color: #64748b; font-size: 0.9rem; }

    .empty {
      text-align: center;
      padding: 80px 20px;
      color: #64748b;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: #0f172acc;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1000;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: #1e293b;
      border-radius: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      border: 1px solid #334155;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.8rem;
      cursor: pointer;
      padding: 0;
    }

    .modal-close:hover { color: #f8fafc; }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: 60vh;
    }

    .meta {
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #334155;
    }

    .meta-row {
      display: flex;
      gap: 12px;
      font-size: 0.95rem;
    }

    .meta-label { color: #64748b; min-width: 70px; }
    .meta-value { color: #e2e8f0; word-break: break-all; }

    .email-body {
      color: #e2e8f0;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .email-body iframe {
      width: 100%;
      min-height: 400px;
      border: none;
      border-radius: 8px;
      background: white;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #10b981;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      transform: translateX(150%);
      transition: transform 0.3s;
      z-index: 2000;
    }

    .toast.show { transform: translateX(0); }

    @media (max-width: 640px) {
      h1 { font-size: 1.8rem; }
      .email-row { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìß Live Temp Mail</h1>
      <p class="subtitle">Generate, receive, and read emails ‚Äî all in one page</p>
    </header>

    <div class="warning">
      ‚ö†Ô∏è <strong>Step 1:</strong> Deploy the backend worker first, then paste your URL below.
    </div>

    <div class="card">
      <div class="card" style="margin-bottom: 16px;">
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <input 
            type="text" 
            id="serverUrl" 
            class="email-input" 
            placeholder="Paste your worker URL (e.g., https://temp-mail.yourname.workers.dev)"
            style="font-size: 0.95rem;"
          />
          <button class="btn btn-secondary" onclick="saveServer()">Save & Connect</button>
        </div>
      </div>

      <div class="email-row">
        <input type="text" id="email" class="email-input" readonly placeholder="Click Generate to create email" />
        <button class="btn btn-secondary" onclick="copyEmail()">üìã Copy</button>
        <button class="btn btn-primary" onclick="generateEmail()">üîÑ Generate</button>
      </div>
      
      <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px;">
        <span id="status" class="status status-checking">
          <span class="pulse"></span>
          <span id="statusText">Enter your server URL above</span>
        </span>
        <button class="btn btn-secondary" onclick="checkInbox()">üîÑ Refresh</button>
      </div>
    </div>

    <div class="card">
      <div class="inbox-header">
        <span class="inbox-title">üì• Inbox</span>
        <span id="count" class="badge">0</span>
      </div>
      <div id="inbox" class="email-list">
        <div class="empty">
          <div style="font-size: 3rem; margin-bottom: 12px;">üì≠</div>
          <p>No emails yet. Click "Generate" to start.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Viewer Modal -->
  <div id="modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <span style="font-weight: 600;">üìß Email Details</span>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="meta">
          <div class="meta-row">
            <span class="meta-label">From:</span>
            <span id="m-from" class="meta-value"></span>
          </div>
          <div class="meta-row">
            <span class="meta-label">To:</span>
            <span id="m-to" class="meta-value"></span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Date:</span>
            <span id="m-date" class="meta-value"></span>
          </div>
          <div class="meta-row">
            <span class="meta-label">Subject:</span>
            <span id="m-subject" class="meta-value"></span>
          </div>
        </div>
        <div id="m-body" class="email-body"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <script>
    // ============================================
    // CONFIGURATION - AUTO-SAVED IN BROWSER
    // ============================================
    const SERVER_URL_KEY = 'tempMailServerUrl';
    let API_URL = localStorage.getItem(SERVER_URL_KEY) || '';
    let currentEmail = null;
    let emailParts = null;
    let messages = [];
    let pollInterval = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      const savedUrl = localStorage.getItem(SERVER_URL_KEY);
      if (savedUrl) {
        document.getElementById('serverUrl').value = savedUrl;
        API_URL = savedUrl;
        updateStatus('Ready to generate email', 'checking');
      }
    });

    function saveServer() {
      const url = document.getElementById('serverUrl').value.trim();
      if (!url) {
        alert('Please enter a valid URL');
        return;
      }
      
      // Ensure URL is clean
      API_URL = url.replace(/\/$/, '');
      localStorage.setItem(SERVER_URL_KEY, API_URL);
      
      showToast('‚úÖ Server saved! Click Generate to start.');
      updateStatus('Ready to generate email', 'checking');
    }

    // ============================================
    // EMAIL GENERATION
    // ============================================
    async function generateEmail() {
      if (!API_URL) {
        alert('Please save your server URL first!');
        document.getElementById('serverUrl').focus();
        return;
      }

      // Stop any existing polling
      if (pollInterval) clearInterval(pollInterval);
      messages = [];
      renderInbox();

      updateStatus('Generating email...', 'checking');

      try {
        const response = await fetch(`${API_URL}/generate`);
        const data = await response.json();
        
        currentEmail = data.email;
        emailParts = { login: data.username, domain: data.domain };
        
        document.getElementById('email').value = currentEmail;
        
        updateStatus('Email created! Checking inbox...', 'connected');
        
        // Start auto-polling
        checkInbox(); // immediate check
        pollInterval = setInterval(checkInbox, 5000); // every 5 seconds
        
        showToast(`‚úÖ Email generated: ${currentEmail}`);
        
      } catch (err) {
        console.error('Generate failed:', err);
        updateStatus('‚ùå Generation failed', 'checking');
        showToast('Error: Check server URL and try again');
      }
    }

    // ============================================
    // INBOX AUTO-CHECKING
    // ============================================
    async function checkInbox() {
      if (!emailParts) return;

      const { login, domain } = emailParts;
      
      try {
        const response = await fetch(`${API_URL}/inbox/${encodeURIComponent(currentEmail)}`);
        const data = await response.json();

        if (data.error) throw new Error(data.error);

        // Process new messages
        const currentIds = new Set(messages.map(m => m.id));
        const newMessages = [];

        for (const msg of data.messages) {
          if (!currentIds.has(msg.id)) {
            newMessages.push(msg);
          }
        }

        if (newMessages.length > 0) {
          messages.unshift(...newMessages);
          renderInbox();
          showToast(`üìß ${newMessages.length} new email(s)!`);
        }

        updateStatus(`‚úÖ Live ‚Ä¢ ${messages.length} emails`, 'connected');

      } catch (err) {
        console.error('Inbox check failed:', err);
        updateStatus('‚ö†Ô∏è Connection issue - retrying...', 'checking');
      }
    }

    // ============================================
    // RENDER EMAILS
    // ============================================
    function renderInbox() {
      const inbox = document.getElementById('inbox');
      const count = document.getElementById('count');
      
      count.textContent = messages.length;

      if (messages.length === 0) {
        inbox.innerHTML = `
          <div class="empty">
            <div style="font-size: 3rem; margin-bottom: 12px;">üì≠</div>
            <p>Waiting for emails...</p>
            <p style="font-size: 0.9rem; margin-top: 8px;">Send an email to ${currentEmail || 'your address'}</p>
          </div>
        `;
        return;
      }

      inbox.innerHTML = messages.map(msg => `
        <div class="email-item" onclick="openEmail(${msg.id})">
          <div class="email-from">${escapeHtml(msg.from)}</div>
          <div class="email-subject">${escapeHtml(msg.subject || '(No subject)')}</div>
          <div class="email-preview">${escapeHtml(msg.body.substring(0, 150))}...</div>
        </div>
      `).join('');
    }

    // ============================================
    // EMAIL VIEWER
    // ============================================
    function openEmail(id) {
      const msg = messages.find(m => m.id === id);
      if (!msg) return;

      document.getElementById('m-from').textContent = msg.from;
      document.getElementById('m-to').textContent = currentEmail;
      document.getElementById('m-date').textContent = new Date(msg.date).toLocaleString();
      document.getElementById('m-subject').textContent = msg.subject || '(No subject)';

      const bodyDiv = document.getElementById('m-body');
      
      if (msg.htmlBody) {
        // Display HTML in iframe for safety
        bodyDiv.innerHTML = `<iframe sandbox="allow-same-origin" srcdoc="${escapeHtml(msg.htmlBody)}"></iframe>`;
      } else {
        bodyDiv.textContent = msg.body;
      }

      document.getElementById('modal').classList.add('active');
    }

    function closeModal(event) {
      if (!event || event.target.id === 'modal') {
        document.getElementById('modal').classList.remove('active');
      }
    }

    // ============================================
    // UTILITIES
    // ============================================
    async function copyEmail() {
      const email = document.getElementById('email').value;
      if (!email) return;

      try {
        await navigator.clipboard.writeText(email);
        showToast('‚úÖ Copied to clipboard!');
      } catch {
        document.getElementById('email').select();
        showToast('Selected - press Ctrl+C');
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function updateStatus(text, type) {
      const status = document.getElementById('status');
      const statusText = document.getElementById('statusText');
      status.className = `status status-${type}`;
      statusText.textContent = text;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
    });
  </script>
</body>
</html>
